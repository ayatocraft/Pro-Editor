<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高機能コードエディタ (リポジトリモード)</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/dialog/dialog.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/search/searchcursor.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/search/search.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/dialog/dialog.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        /* --- CSS（基本レイアウト）--- */
        html, body {
            height: 100%;
            margin: 0;
            font-family: sans-serif;
            background-color: #f4f4f4;
            display: flex;
            flex-direction: column;
        }
        body {
            padding: 10px;
            box-sizing: border-box;
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 10px;
            background: #fff;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            align-items: center;
        }
        .controls > div {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .container {
            display: flex;
            flex: 1;
            gap: 10px;
            overflow: hidden;
        }
        
        /* --- ペイン共通 --- */
        .pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .pane-header {
            padding: 10px;
            background: #eee;
            font-weight: bold;
            border-bottom: 1px solid #ccc;
        }
        
        /* --- ファイルエクスプローラー --- */
        #fileExplorer {
            flex: 0 0 200px;
            border-right: 1px solid #ccc;
        }
        #fileAddControls {
            padding: 5px;
            display: flex;
            gap: 5px;
        }
        #newFileName {
            flex: 1;
            width: 100px;
            padding: 4px;
        }
        #addFileButton {
            padding: 4px 8px;
            font-size: 0.8rem;
        }
        #fileList {
            list-style: none;
            padding: 0;
            margin: 0;
            overflow-y: auto;
            flex: 1;
        }
        
        /* ★ ファイル項目 (削除ボタン対応) ★ */
        .file-item {
            display: flex; /* Flexboxに変更 */
            justify-content: space-between; /* 両端揃え */
            align-items: center; /* 中央揃え */
            padding: 8px 10px;
            cursor: pointer;
            font-size: 0.9rem;
            border-bottom: 1px solid #f0f0f0;
        }
        .file-name { /* ファイル名表示用スパン */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1; /* スペースを埋める */
        }
        .file-item:hover {
            background-color: #f5f5f5;
        }
        .file-item.active-file {
            background-color: #007bff;
            color: white;
            font-weight: bold;
        }
        
        /* ★ 削除ボタン ★ */
        .delete-file-btn {
            background: none;
            border: 1px solid #ff4d4d;
            color: #ff4d4d;
            border-radius: 3px;
            padding: 2px 5px;
            font-size: 0.8rem;
            line-height: 1;
            cursor: pointer;
            margin-left: 5px;
        }
        .delete-file-btn:hover {
            background-color: #ff4d4d;
            color: white;
        }
        .file-item.active-file .delete-file-btn {
            color: #fff;
            border-color: #fff;
        }

        /* --- エディタラッパー --- */
        .editor-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .CodeMirror {
            border: none;
            flex: 1;
            height: auto;
            font-size: 14px;
        }
        
        #previewFrame {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* --- 汎用コントロール --- */
        input[type="text"], select {
            font-size: 1rem;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            font-size: 1rem;
            padding: 8px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover { background-color: #0056b3; }
        .search-button { background-color: #6c757d; }
        .search-button:hover { background-color: #5a6268; }

        .hidden {
            display: none;
        }

        /* --- モバイル対応CSS --- */
        @media (max-width: 768px) {
            body {
                padding: 5px;
            }
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            .controls > div {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            .controls button, .controls select, .controls input[type="text"] {
                width: 100%;
                box-sizing: border-box;
            }
            .container {
                flex-direction: column;
            }
            .editor-pane {
                flex-direction: column;
                height: 400px;
                flex: 1;
            }
            #fileExplorer {
                flex: 0 0 auto;
                border-right: none;
                border-bottom: 1px solid #ccc;
                max-height: 150px;
                display: flex;
                flex-direction: column;
            }
            .editor-wrapper {
                height: auto;
                flex: 1;
            }
            .preview-pane {
                height: 400px;
                flex: 1;
            }
        }
    </style>
</head>
<body>

    <div class="controls">
        <div>
            <label for="fileName">ファイル名 / ZIP名:</label>
            <input type="text" id="fileName" value="myProject">
        </div>
        <div>
            <label for="fileType">出力先:</label>
            <select id="fileType">
                <option value="repository" data-ext=".zip">リポジトリ (.zip)</option>
                <option value="htmlmixed" data-ext=".html">HTML (.html)</option>
                <option value="javascript" data-ext=".js">JavaScript (.js)</option>
                <option value="css" data-ext=".css">CSS (.css)</option>
                <option value="application/json" data-ext=".json">JSON (.json)</option>
                <option value="xml" data-ext=".md">Markdown (.md)</option>
                <option value="custom" data-ext="">カスタム...</option>
            </select>
        </div>
        <div id="customExtWrapper" class="hidden">
            <label for="customExt">カスタム拡張子:</label>
            <input type="text" id="customExt" placeholder=".exe など">
        </div>
        <div>
            <label for="encoding">文字コード:</label>
            <select id="encoding">
                <option value="UTF-8">UTF-8</option>
                <option value="Shift_JIS">Shift_JIS (SJIS)</option>
            </select>
        </div>
        <div id="htmlAuxOptions" class="hidden">
            <input type="checkbox" id="auxCheckbox" style="width: auto;">
            <label for="auxCheckbox">HTMLテンプレート補助</label>
        </div>
        <div>
            <button id="searchButton" class="search-button">コード内検索 (ハイライト)</button>
        </div>
        <div>
            <button id="downloadButton">ダウンロード</button>
        </div>
    </div>

    <div class="container">
        <div class="editor-pane pane">
            <div id="fileExplorer" class="hidden">
                <div class="pane-header" id="fileExplorerHeader">
                    ファイル一覧
                </div>
                <ul id="fileList"></ul>
                <div id="fileAddControls">
                    <input type="text" id="newFileName" placeholder="index.html">
                    <button id="addFileButton">+</button>
                </div>
            </div>
            <div class="editor-wrapper">
                <div class="pane-header" id="editorHeader">エディタ</div>
                <textarea id="codeInput"></textarea>
            </div>
        </div>
        <div id="previewPane" class="preview-pane pane hidden">
            <div class="pane-header" id="previewHeader">プレビュー</div>
            <iframe id="previewFrame"></iframe>
        </div>
    </div>


    <script>
        // --- グローバル変数 ---
        let isRepoMode = false;
        let files = {};
        let activeFile = null;
        
        // --- HTMLテンプレート ---
        const htmlTemplate = `<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Title</title>
    <style>
        
    <\/style>
</head>
<body>
    <h1>Hello World!</h1>
    <script>
        
    <\/script>
</body>
</html>
`;

        // --- 1. 必要な要素を取得 ---
        const fileTypeSelect = document.getElementById('fileType');
        const customExtWrapper = document.getElementById('customExtWrapper');
        const customExtInput = document.getElementById('customExt');
        const htmlAuxOptions = document.getElementById('htmlAuxOptions');
        const auxCheckbox = document.getElementById('auxCheckbox');
        const previewPane = document.getElementById('previewPane');
        const previewFrame = document.getElementById('previewFrame');
        const fileNameInput = document.getElementById('fileName');
        const encodingSelect = document.getElementById('encoding');
        const downloadButton = document.getElementById('downloadButton');
        const searchButton = document.getElementById('searchButton');
        const fileExplorer = document.getElementById('fileExplorer');
        const fileList = document.getElementById('fileList');
        const newFileNameInput = document.getElementById('newFileName');
        const addFileButton = document.getElementById('addFileButton');
        const editorHeader = document.getElementById('editorHeader');

        // --- 2. CodeMirrorエディタを初期化 ---
        const editor = CodeMirror.fromTextArea(document.getElementById('codeInput'), {
            lineNumbers: true,
            mode: 'htmlmixed',
        });

        // --- 3. リポジトリモード UI管理 ---

        // ★ ファイル一覧を再描画 (削除ボタン追加)
        function renderFileList() {
            fileList.innerHTML = '';
            Object.keys(files).sort().forEach(filename => {
                const li = document.createElement('li');
                li.className = 'file-item';
                // ★ ファイル名スパンと削除ボタンを追加
                li.innerHTML = `<span class="file-name">${filename}</span>
                                <button class="delete-file-btn" data-filename="${filename}">×</button>`;
                
                // li全体にファイル名データを持たせる (読み込み用)
                li.dataset.filename = filename; 

                if (filename === activeFile) {
                    li.classList.add('active-file');
                }
                fileList.appendChild(li);
            });
        }

        // アクティブなファイルをエディタに読み込む
        function loadFileIntoEditor(filename) {
            if (!files.hasOwnProperty(filename)) return;

            saveActiveFile();
            
            activeFile = filename;
            editor.setValue(files[filename]);
            editorHeader.textContent = `エディタ (${filename})`;
            
            let mode = 'text/plain';
            if (filename.endsWith('.html')) mode = 'htmlmixed';
            else if (filename.endsWith('.js')) mode = 'javascript';
            else if (filename.endsWith('.css')) mode = 'css';
            else if (filename.endsWith('.json')) mode = 'application/json';
            else if (filename.endsWith('.md')) mode = 'xml';
            editor.setOption('mode', mode);

            // HTML補助オプションの表示/非表示を切り替え
            if (filename.endsWith('.html')) {
                htmlAuxOptions.classList.remove('hidden');
                auxCheckbox.checked = false; // チェック状態をリセット
            } else {
                htmlAuxOptions.classList.add('hidden');
            }

            renderFileList();
        }

        // 現在エディタにある内容をファイルストアに保存
        function saveActiveFile() {
            if (activeFile && files.hasOwnProperty(activeFile)) {
                files[activeFile] = editor.getValue();
            }
        }

        // ★ 新しい関数: ファイル削除
        function deleteFile(filename) {
            if (!confirm(`本当に「${filename}」を削除しますか？`)) {
                return; // キャンセルされたら何もしない
            }

            // 1. ファイルをオブジェクトから削除
            delete files[filename];

            // 2. もしアクティブなファイルが削除されたファイルなら、エディタをリセット
            if (activeFile === filename) {
                activeFile = null;
                editor.setValue('');
                editorHeader.textContent = 'エディタ (ファイルを選択してください)';
                editor.setOption('mode', 'text/plain');
                htmlAuxOptions.classList.add('hidden'); // 補助オプションも隠す
            }

            // 3. ファイル一覧を再描画
            renderFileList();

            // 4. プレビューを更新 (index.htmlが消えた可能性などを考慮)
            updateRepoPreview();
        }

        // リポジトリモードの初期化 (空の状態で開始)
        function initRepoMode() {
            isRepoMode = true;
            files = {}; 
            activeFile = null;

            fileExplorer.classList.remove('hidden');
            previewPane.classList.remove('hidden');
            customExtWrapper.classList.add('hidden');
            
            editor.setValue(''); 
            editorHeader.textContent = 'エディタ (ファイルを追加してください)';
            editor.setOption('mode', 'text/plain');
            
            renderFileList(); 
            updateRepoPreview(null); 
            
            htmlAuxOptions.classList.add('hidden'); 
        }

        // リポジトリモードの終了
        function exitRepoMode() {
            isRepoMode = false;
            saveActiveFile();
            fileExplorer.classList.add('hidden');
            htmlAuxOptions.classList.add('hidden'); 
        }
        
        // HTMLテンプレートを挿入/削除する関数
        function toggleHtmlTemplate() {
            if (auxCheckbox.checked) {
                editor.setValue(htmlTemplate);
            } else {
                editor.setValue('');
            }
        }


        // --- 4. プレビュー管理 ---

        // 単一HTMLファイルプレビュー
        function updateSingleFilePreview() {
            if (fileTypeSelect.value === 'htmlmixed') {
                previewFrame.srcdoc = editor.getValue();
            }
        }

        // 拡張子からMIMEタイプを取得
        function getMimeType(filename) {
            if (filename.endsWith('.html')) return 'text/html';
            if (filename.endsWith('.css')) return 'text/css';
            if (filename.endsWith('.js')) return 'text/javascript';
            return 'application/octet-stream';
        }

        // テキストをData URL (Base64) に変換
        function textToDataUrl(text, mimeType) {
            try {
                const utf8Bytes = unescape(encodeURIComponent(text));
                const base64 = btoa(utf8Bytes);
                return `data:${mimeType};base64,${base64}`;
            } catch (e) {
                console.error("Base64エンコードに失敗:", e);
                return '';
            }
        }

        // リポジトリプレビュー
        function updateRepoPreview(targetFilename = 'index.html') {
            if (!isRepoMode || !targetFilename || !files.hasOwnProperty(targetFilename)) {
                let message = "プレビューするHTMLファイルを選択してください。";
                if (isRepoMode && Object.keys(files).length > 0 && !files.hasOwnProperty('index.html')) {
                    message = "index.html が見つかりません。";
                } else if (isRepoMode && Object.keys(files).length === 0) {
                    message = "ファイルがありません。ファイルを追加してください。";
                }
                previewFrame.srcdoc = `<body style="font-family: sans-serif; padding: 20px; color: #555;">${message}</body>`;
                return;
            }

            let htmlContent = files[targetFilename];
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlContent, 'text/html');

            // CSS <link href="..."> を置換
            doc.querySelectorAll('link[href]').forEach(link => {
                const href = link.getAttribute('href');
                if (href && !href.startsWith('http') && !href.startsWith('data:')) {
                    if (files.hasOwnProperty(href)) {
                        const mimeType = getMimeType(href);
                        const dataUrl = textToDataUrl(files[href], mimeType);
                        link.setAttribute('href', dataUrl);
                    }
                }
            });

            // JS <script src="..."> を置換
            doc.querySelectorAll('script[src]').forEach(script => {
                const src = script.getAttribute('src');
                if (src && !src.startsWith('http') && !src.startsWith('data:')) {
                    if (files.hasOwnProperty(src)) {
                        const mimeType = getMimeType(src);
                        const dataUrl = textToDataUrl(files[src], mimeType);
                        script.setAttribute('src', dataUrl);
                    }
                }
            });
            
            const newHtmlContent = doc.documentElement.outerHTML;
            previewFrame.srcdoc = newHtmlContent;
        }

        // プレビュー内リンクのクリックを検知
        previewFrame.addEventListener('load', () => {
            if (!isRepoMode) return;
            
            try {
                const iDoc = previewFrame.contentWindow.document;
                iDoc.querySelectorAll('a').forEach(link => {
                    link.addEventListener('click', e => {
                        e.preventDefault();
                        const href = link.getAttribute('href');
                        if (!href || href.startsWith('http') || href.startsWith('#')) return;
                        const targetFile = href.split('/').pop();
                        
                        if (files.hasOwnProperty(targetFile) && targetFile.endsWith('.html')) {
                            updateRepoPreview(targetFile); 
                        }
                    });
                });
            } catch (e) {
                // (エラー処理)
            }
        });


        // --- 5. イベントリスナー設定 ---

        // 出力先(select)変更：モード切替
        fileTypeSelect.addEventListener('change', () => {
            const selectedOption = fileTypeSelect.options[fileTypeSelect.selectedIndex];
            const mode = selectedOption.value;

            if (mode === 'repository') {
                initRepoMode();
                return;
            }
            if (isRepoMode) {
                exitRepoMode();
            }

            customExtWrapper.classList.toggle('hidden', mode !== 'custom');
            const isHtml = (mode === 'htmlmixed');
            
            htmlAuxOptions.classList.toggle('hidden', !isHtml);
            previewPane.classList.toggle('hidden', !isHtml);
            
            if (isHtml) {
                editor.setOption('mode', 'htmlmixed');
                auxCheckbox.checked = false; 
                toggleHtmlTemplate(); 
                updateSingleFilePreview();
            } else {
                editor.setOption('mode', mode);
            }
            editorHeader.textContent = 'エディタ';
        });

        // HTML補助チェックボックス
        auxCheckbox.addEventListener('change', toggleHtmlTemplate);

        // エディタ内容変更
        let debounceTimer;
        editor.on('change', () => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                if (isRepoMode) {
                    saveActiveFile();
                    if (activeFile && activeFile.endsWith('.html')) {
                        updateRepoPreview(activeFile);
                    }
                } else {
                    updateSingleFilePreview();
                }
            }, 300);
        });

        // 検索ボタン
        searchButton.addEventListener('click', () => editor.execCommand('find'));

        // ★ fileListのクリックイベントリスナー (削除と読み込みの分岐)
        fileList.addEventListener('click', (e) => {
            const target = e.target;

            // 削除ボタンが押された場合
            if (target.classList.contains('delete-file-btn')) {
                const filename = target.dataset.filename;
                deleteFile(filename);
                return; // 読み込み処理は行わない
            }

            // ファイル名(span)またはli本体がクリックされた場合
            // closest()で親の.file-itemを探す
            const fileItem = target.closest('.file-item');
            if (fileItem) {
                const filename = fileItem.dataset.filename;
                loadFileIntoEditor(filename);
            }
        });

        // ファイル追加ボタン
        addFileButton.addEventListener('click', () => {
            const filename = newFileNameInput.value.trim();
            if (!filename) {
                alert('ファイル名を入力してください。');
                return;
            }
            if (files.hasOwnProperty(filename)) {
                alert('同じ名前のファイルが既に存在します。');
                return;
            }
            
            files[filename] = ''; // 空のファイルを作成
            newFileNameInput.value = '';
            renderFileList();
            loadFileIntoEditor(filename); // 新規作成したファイルをアクティブに
        });


        // --- 6. ダウンロード処理 ---
        downloadButton.addEventListener('click', () => {
            if (isRepoMode) {
                downloadZip();
            } else {
                downloadSingleFile();
            }
        });

        function downloadSingleFile() {
            const textData = editor.getValue();
            const fileName = fileNameInput.value || 'download';
            let fileExtension = '';
            const selectedOption = fileTypeSelect.options[fileTypeSelect.selectedIndex];
            
            if (selectedOption.value === 'custom') {
                fileExtension = customExtInput.value;
            } else {
                fileExtension = selectedOption.dataset.ext;
            }
            
            const fullFileName = fileName + fileExtension;
            const encoding = encodingSelect.value;
            const blob = new Blob([textData], { type: `application/octet-stream;charset=${encoding}` });
            triggerDownload(blob, fullFileName);
        }

        function downloadZip() {
            saveActiveFile();
            
            // ★ もしファイルが0件なら警告
            if (Object.keys(files).length === 0) {
                alert('リポジトリにファイルがありません。');
                return;
            }

            const zip = new JSZip();
            for (const [filename, content] of Object.entries(files)) {
                zip.file(filename, content);
            }
            const zipName = (fileNameInput.value || 'project') + '.zip';
            
            zip.generateAsync({ type: "blob" })
                .then(blob => {
                    triggerDownload(blob, zipName);
                })
                .catch(e => {
                    console.error("ZIPの作成に失敗しました:", e);
                    alert("ZIPの作成に失敗しました。");
                });
        }
        
        function triggerDownload(blob, filename) {
            const downloadLink = document.createElement('a');
            downloadLink.href = URL.createObjectURL(blob);
            downloadLink.download = filename;
            downloadLink.click();
            URL.revokeObjectURL(downloadLink.href);
        }

        // --- 7. 初期読み込み ---
        // デフォルトでリポジトリモードを起動
        fileTypeSelect.value = 'repository';
        fileTypeSelect.dispatchEvent(new Event('change'));

    </script>

</body>
</html>
